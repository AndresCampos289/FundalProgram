<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ver Expediente de <%= nino.nombre_completo %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="/css/postulaciones.css" rel="stylesheet">
  <link href="/css/navbarStyles.css" rel="stylesheet">
</head>
<body>
  <%- include('navbar') %>

  <div class="container mt-5">
      <div class="main-card"> <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Expediente de: <%= nino.nombre_completo %></h2>
      <a href="/expedientes" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Volver</a>
    </div>

    <!-- Mensajes Flash -->
    <% if (success_msg) { %><div class="alert alert-success alert-dismissible fade show" role="alert"><%= success_msg %><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div><% } %>
    <% if (error_msg) { %><div class="alert alert-danger alert-dismissible fade show" role="alert"><% if (Array.isArray(error_msg)) { %><ul><% error_msg.forEach(function(error) { %><li><%= error.msg || error %></li><% }); %></ul><% } else { %><%= error_msg %><% } %><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div><% } %>

    <!-- Pestañas de Navegación -->
    <ul class="nav nav-tabs mb-4" id="expedienteTabs" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" id="anual-tab" data-bs-toggle="tab" data-bs-target="#anual" type="button" role="tab">Información Anual</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" id="datos-tab" data-bs-toggle="tab" data-bs-target="#datos" type="button" role="tab">Datos Generales</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" id="representantes-tab" data-bs-toggle="tab" data-bs-target="#representantes" type="button" role="tab">Representantes</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" id="documentos-tab" data-bs-toggle="tab" data-bs-target="#documentos" type="button" role="tab">Documentos</button></li>
    </ul>

    <div class="tab-content" id="expedienteTabsContent">
      <!-- PESTAÑA 1: INFORMACIÓN ANUAL -->
      <div class="tab-pane fade show active" id="anual" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center"><label for="anioSeleccion" class="form-label me-2 mb-0">Año Escolar:</label><select id="anioSeleccion" class="form-select w-auto" onchange="window.location.href = this.value"><% expedientesAnuales.forEach(exp => { %><option value="/expedientes/<%= nino.id %>/<%= exp.anio %>" <%= (anioSeleccionado == exp.anio) ? 'selected' : '' %>><%= exp.anio %></option><% }) %><% if (expedientesAnuales.length === 0) { %><option selected disabled>No hay años</option><% } %></select></div><button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarAnioModal"><i class="fas fa-plus"></i> Agregar Nuevo Año</button>
          </div>
          <div class="card-body">
            <% if (expedienteDelAnio) { %><h5 class="card-title">Detalles del Año <%= anioSeleccionado %></h5><p><strong>Grado:</strong> <%= expedienteDelAnio.grado || 'N/A' %></p><p><strong>Programa Asignado:</strong> <%= expedienteDelAnio.programa_asignado || 'N/A' %></p><p><strong>Observaciones:</strong></p><p class="ms-3"><%- expedienteDelAnio.observaciones ? expedienteDelAnio.observaciones.replace(/\n/g, '<br>') : 'N/A' %></p><% } else { %><div class="alert alert-warning">No hay información registrada para el año <%= anioSeleccionado %>.</div><% } %>
          </div>
        </div>
      </div>

      <!-- PESTAÑA 2: DATOS GENERALES -->
      <div class="tab-pane fade" id="datos" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6"><p><strong>Código:</strong> <%= nino.codigo %></p></div>
              <div class="col-md-6"><p><strong>Nombre Completo:</strong> <%= nino.nombre_completo %></p></div>
              <div class="col-md-6"><p><strong>Fecha de Nacimiento:</strong> <%= nino.fecha_nacimiento ? new Date(nino.fecha_nacimiento).toLocaleDateString() : 'N/A' %></p></div>
              <div class="col-md-6"><p><strong>Edad:</strong> <%= nino.edad || 'N/A' %></p></div>
              <div class="col-md-6"><p><strong>Diagnóstico:</strong> <%= nino.diagnostico || 'N/A' %></p></div>
              <div class="col-md-6"><p><strong>Referido por:</strong> <%= nino.referido_por || 'N/A' %></p></div>
            </div>
            <div class="d-flex justify-content-end mt-3">
              <a href="/expedientes/editar/<%= nino.id %>" class="btn btn-warning">✏️ Editar Datos Generales</a>
            </div>
          </div>
        </div>
      </div>

      <!-- PESTAÑA 3: REPRESENTANTES -->
      <div class="tab-pane fade" id="representantes" role="tabpanel">
        <% if (representantes && representantes.length > 0) { %>
          <% representantes.forEach(r => { %>
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title"><%= r.nombre %></h5>
                <p class="card-text mb-1"><strong>DPI:</strong> <%= r.dpi || 'N/A' %></p>
                <p class="card-text mb-1"><strong>Parentesco:</strong> <%= r.parentesco || 'N/A' %></p>
                <p class="card-text mb-1"><strong>Teléfono:</strong> <%= r.telefono || 'N/A' %></p>
                <p class="card-text mb-0"><strong>Dirección:</strong> <%= r.direccion || 'N/A' %></p>
              </div>
            </div>
          <% }) %>
        <% } else { %><p>No hay representantes legales registrados.</p><% } %>
      </div>

      <!-- PESTAÑA 4: DOCUMENTOS (DISEÑO CORREGIDO) -->
      <div class="tab-pane fade" id="documentos" role="tabpanel">
        <% if (expedienteDelAnio) { %>
            <!-- Formulario para subir nuevos documentos -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">Subir Nuevo Documento para <%= anioSeleccionado %></h5></div>
                <div class="card-body">
                    <form action="/expedientes/<%= nino.id %>/<%= anioSeleccionado %>/documento/subir" method="POST" enctype="multipart/form-data" class="row g-3">
                        <div class="col-md-6"><label class="form-label">Tipo de Documento*</label><select name="documento_tipo" class="form-select" required><option value="" selected disabled>Seleccione...</option><option value="Certificado de nacimiento">Certificado de nacimiento</option><option value="DPI de padres">DPI de padres</option><option value="Informe Médico">Informe Médico</option><option value="Boleta de Calificaciones">Boleta de Calificaciones</option><option value="Otros">Otros</option></select></div>
                        <div class="col-md-6"><label class="form-label">Archivo*</label><input type="file" name="documento_archivo" class="form-control" required></div>
                        <div class="col-12 text-end"><button type="submit" class="btn btn-success"><i class="fas fa-upload"></i> Subir</button></div>
                    </form>
                </div>
            </div>

            <!-- Lista de documentos existentes -->
            <h5 class="mt-4">Documentos Registrados en <%= anioSeleccionado %></h5>
            <ul class="list-group">
                <% if (documentos && documentos.length > 0) { %>
                  <% documentos.forEach(d => { %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div><strong><i class="fas fa-file-alt me-2"></i><%= d.tipo %></strong><br><small class="text-muted">Subido: <%= new Date(d.fecha_subida).toLocaleDateString() %></small></div>
                      <div>
                        <a href="/<%= d.archivo %>" class="btn btn-sm btn-info" target="_blank"><i class="fas fa-eye"></i> Ver</a>
                        <form action="/expedientes/documento/<%= d.id %>/eliminar" method="POST" class="d-inline" onsubmit="return confirm('¿Estás seguro de que quieres eliminar este documento?');">
                          <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> Eliminar</button>
                        </form>
                      </div>
                    </li>
                  <% }) %>
                <% } else { %>
                  <li class="list-group-item text-center">No hay documentos para este año.</li>
                <% } %>
            </ul>
        <% } else { %>
            <div class="alert alert-info"><i class="fas fa-info-circle"></i> Para gestionar documentos, primero debe existir un registro para el año escolar. Puede crearlo en la pestaña "Información Anual".</div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Modal para Agregar Nuevo Año Escolar -->
  <div class="modal fade" id="agregarAnioModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="modalLabel">Agregar Año para <%= nino.nombre_completo %></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <form action="/expedientes/<%= nino.id %>/agregar-anio" method="POST">
          <div class="modal-body">
            <div class="mb-3"><label for="anio" class="form-label">Año Escolar*</label><input type="number" class="form-control" name="anio" value="<%= new Date().getFullYear() %>" required></div>
            <div class="mb-3"><label for="grado" class="form-label">Grado*</label><input type="text" class="form-control" name="grado" required></div>
            <div class="mb-3"><label for="programa_asignado" class="form-label">Programa Asignado</label><input type="text" class="form-control" name="programa_asignado"></div>
            <div class="mb-3"><label for="observaciones" class="form-label">Observaciones</label><textarea class="form-control" name="observaciones" rows="3"></textarea></div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Guardar Año</button></div>
        </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

