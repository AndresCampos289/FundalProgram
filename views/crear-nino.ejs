<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Crear Nuevo Niño</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="/css/formCrearnino.css" rel="stylesheet">
  <link href="/css/navbarStyles.css" rel="stylesheet">
</head>
<body>
  <%- include('navbar') %>

  <div class="container-fluid mt-5 mb-5">
    <div class="main-card">
      <div class="page-header">
        <h2>Expediente de Nuevo Niño</h2>
      </div>

      <div class="progress-bar-container">
        <div class="step active" data-step="1">
          <div class="step-icon">1</div>
          <div class="step-label">Datos del Niño</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-icon">2</div>
          <div class="step-label">Expediente Anual</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-icon">3</div>
          <div class="step-label">Representante</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-icon">4</div>
          <div class="step-label">Documentos</div>
        </div>
      </div>
      <% if (success_msg && success_msg.length > 0) { %><div class="alert alert-success alert-dismissible fade show" role="alert"><%= success_msg %><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div><% } %>
      <% if (error_msg && error_msg.length > 0) { %><div class="alert alert-danger alert-dismissible fade show" role="alert"><% if (Array.isArray(error_msg)) { %><ul><% error_msg.forEach(function(error) { %><li><%= error %></li><% }); %></ul><% } else { %><%- error_msg %><% } %><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div><% } %>

      <form action="/crear-nino" method="POST" enctype="multipart/form-data" id="multiStepForm">
        <% if (formData && formData.fromPostulationId) { %><input type="hidden" name="fromPostulationId" value="<%= formData.fromPostulationId %>"><% } %>

        <div class="form-step active" data-step="1">
          <h5 class="form-section-title">Datos del Niño</h5>
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">Código*</label><input type="text" name="codigo" class="form-control" required value="<%= formData.codigo || '' %>"></div>
            <div class="col-md-4"><label class="form-label">Nombre Completo*</label><input type="text" name="nombre_completo" class="form-control" required value="<%= formData.nombre_completo || '' %>"></div>
            <div class="col-md-4"><label class="form-label">Fecha de Nacimiento</label><input type="date" name="fecha_nacimiento" id="fechaNacimiento" class="form-control" value="<%= formData.fecha_nacimiento ? new Date(formData.fecha_nacimiento).toISOString().slice(0, 10) : '' %>"></div>
            <div class="col-md-4"><label class="form-label">Edad</label><input type="number" step="1" name="edad" id="edad" class="form-control" value="<%= formData.edad || '' %>"></div>
            <div class="col-md-4"><label class="form-label">Referido por</label><input type="text" name="referido_por" class="form-control" value="<%= formData.referido_por || '' %>"></div>
            <div class="col-12"><label class="form-label">Diagnóstico</label><textarea name="diagnostico" class="form-control" rows="2"><%= formData.diagnostico || '' %></textarea></div>
          </div>
          <div class="form-navigation">
            <button type="button" class="btn btn-primary next-btn">Siguiente</button>
          </div>
        </div>
        <div class="form-step" data-step="2">
          <h5 class="form-section-title">Datos del Primer Expediente Anual</h5>
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">Año Escolar*</label><select name="anio_escolar" class="form-select" required><option value="" disabled>Seleccione un año</option><% for (let i = new Date().getFullYear() + 1; i >= 2000; i--) { %><option value="<%= i %>" <%= (formData.anio_escolar == i || anioSugerido == i) ? 'selected' : '' %>><%= i %></option><% } %></select></div>
            <div class="col-md-4"><label class="form-label">Grado</label><input type="text" name="grado" class="form-control" value="<%= formData.grado || '' %>"></div>
            <div class="col-md-4"><label class="form-label">Programa Asignado</label><input type="text" name="programa_asignado" class="form-control" value="<%= formData.programa_asignado || '' %>"></div>
            <div class="col-12"><label class="form-label">Observaciones del Año</label><textarea name="observaciones" class="form-control" rows="2"><%= formData.observaciones || '' %></textarea></div>
          </div>
          <div class="form-navigation">
            <button type="button" class="btn btn-secondary prev-btn">Anterior</button>
            <button type="button" class="btn btn-primary next-btn">Siguiente</button>
          </div>
        </div>
        <div class="form-step" data-step="3">
          <h5 class="form-section-title">Representante Legal</h5>
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">Nombre</label><input type="text" name="representante_nombre" class="form-control" value="<%= formData.representante_nombre || '' %>"></div>
            <div class="col-md-6"><label class="form-label">DPI</label><input type="text" name="representante_dpi" class="form-control" value="<%= formData.representante_dpi || '' %>"></div>
            <div class="col-md-4"><label class="form-label">Parentesco</label><input type="text" name="representante_parentesco" class="form-control" value="<%= formData.representante_parentesco || '' %>"></div>
            <div class="col-md-4"><label class="form-label">Teléfono</label><input type="text" name="representante_telefono" class="form-control" value="<%= formData.representante_telefono || '' %>"></div>
            <div class="col-md-4"><label class="form-label">Dirección</label><input type="text" name="representante_direccion" class="form-control" value="<%= formData.representante_direccion || '' %>"></div>
          </div>
          <div class="form-navigation">
            <button type="button" class="btn btn-secondary prev-btn">Anterior</button>
            <button type="button" class="btn btn-primary next-btn">Siguiente</button>
          </div>
        </div>
        <div class="form-step" data-step="4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="form-section-title mb-0">Documentos</h5>
            <button type="button" class="btn btn-secondary" id="addDocumento"><i class="fas fa-plus me-2"></i>Agregar otro</button>
          </div>
          <div id="documentosContainer">
            <div class="row g-3 documento-group">
              <div class="col-md-5"><label class="form-label">Tipo</label><select name="documento_tipo[]" class="form-select"><option value="" selected disabled>Seleccione...</option><option value="Certificado de nacimiento">Certificado de nacimiento</option><option value="DPI de padres">DPI de padres</option><option value="Ficha de Postulación">Ficha de Postulación</option><option value="Informe Médico">Informe Médico</option><option value="Otros">Otros</option></select></div>
              <div class="col-md-5"><label class="form-label">Archivo</label><input type="file" name="documento_archivo[]" class="form-control"></div>
              <div class="col-md-2 d-flex align-items-end"><button type="button" class="btn btn-danger-soft w-100 remove-documento">Eliminar</button></div>
            </div>
          </div>
          <div class="form-navigation">
            <button type="button" class="btn btn-secondary prev-btn">Anterior</button>
            <button type="submit" class="btn btn-primary btn-lg">Guardar Expediente</button>
          </div>
        </div>
        </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Lógica del formulario por pasos
      const steps = document.querySelectorAll('.step');
      const formSteps = document.querySelectorAll('.form-step');
      const nextBtns = document.querySelectorAll('.next-btn');
      const prevBtns = document.querySelectorAll('.prev-btn');
      const form = document.getElementById('multiStepForm');
      let currentStep = 1;

      function updateSteps() {
        steps.forEach(step => {
          const stepNum = parseInt(step.dataset.step);
          if (stepNum === currentStep) {
            step.classList.add('active');
          } else {
            step.classList.remove('active');
          }
        });

        formSteps.forEach(formStep => {
          formStep.classList.remove('active');
        });

        form.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');
      }

      function validateStep(step) {
          const inputs = formSteps[step - 1].querySelectorAll('input[required], select[required]');
          let isValid = true;
          inputs.forEach(input => {
              if (!input.value.trim()) {
                  isValid = false;
                  // Opcional: añadir clase de error para feedback visual
                  input.classList.add('is-invalid');
              } else {
                  input.classList.remove('is-invalid');
              }
          });
          if (!isValid) alert('Por favor, completa todos los campos requeridos (*).');
          return isValid;
      }


      nextBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          if (validateStep(currentStep) && currentStep < steps.length) {
            currentStep++;
            updateSteps();
          }
        });
      });

      prevBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          if (currentStep > 1) {
            currentStep--;
            updateSteps();
          }
        });
      });

      // Lógica de Documentos
      const documentosContainer = document.getElementById('documentosContainer');
      document.getElementById('addDocumento').addEventListener('click', () => {
        const newGroup = documentosContainer.querySelector('.documento-group').cloneNode(true);
        newGroup.querySelectorAll('input, select').forEach(el => { el.value = ''; });
        documentosContainer.appendChild(newGroup);
      });
      documentosContainer.addEventListener('click', e => {
        if (e.target.classList.contains('remove-documento')) {
          if (documentosContainer.querySelectorAll('.documento-group').length > 1) {
            e.target.closest('.documento-group').remove();
          }
        }
      });

      // Lógica de Edad
      document.getElementById('fechaNacimiento').addEventListener('change', function(e) {
        const edadInput = document.getElementById('edad');
        if (!e.target.value) { edadInput.value = ''; return; }
        const birthDate = new Date(e.target.value);
        let years = new Date().getFullYear() - birthDate.getFullYear();
        const m = new Date().getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && new Date().getDate() < birthDate.getDate())) { years--; }
        edadInput.value = years;
      });

      // Ocultar alertas
      setTimeout(() => { document.querySelectorAll('.alert').forEach(a => new bootstrap.Alert(a).close()); }, 4000);
    });
  </script>
  </body>
</html>